<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Security-Policy" 
          content="
            default-src 'self' 'unsafe-inline';
            connect-src 'self' 'unsafe-inline' https://photonmodmanager.onrender.com;
            script-src  'self' 'unsafe-inline';
            style-src   'self' 'unsafe-inline';
          ">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit - Photon</title>
    <!-- The style.css file allows you to change the look of your web pages.
         If you include the next line in all your web pages, they will all share the same look.
         This makes it easier to make new pages for your site. -->
    <link href="/style.css" rel="stylesheet" type="text/css" media="all">

    <style>
      @keyframes fadeIn 
      {
        from 
        { 
          opacity: 0; 
          transform: scale(0.9); 
        }
        to 
        { 
          opacity: 1; 
          transform: scale(1); 
        }
      }

      .loading-spinner 
      {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin 
      {
        to 
        { 
          transform: rotate(360deg); 
        }
      }

      .image-preview-item 
      {
        animation: fadeIn 0.3s ease;
      }

      .remove-image-btn 
      {
        transition: all 0.2s ease;
      }

      .remove-image-btn:hover 
      {
        background: rgba(255, 59, 48, 0.9) !important;
        transform: scale(1.1);
      }

      .thumbnail-toggle-btn 
      {
        transition: all 0.2s ease;
      }

      .thumbnail-toggle-btn:hover 
      {
        transform: scale(1.1);
      }
    </style>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Browse and download Balatro mods. Photon Mod Manager - Your hub for Balatro modding.">
    <meta name="keywords" content="balatro, mods, modding, balatro mods, card game, roguelike">
    <meta name="author" content="Photon Mod Manager">

    <!-- OpenGraph Meta Tags -->
    <meta property="og:title" content="Photon Mod Manager - Balatro Mods">
    <meta property="og:description" content="Browse, download, and manage Balatro mods with Photon Mod Manager.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://photonmodmanager.onrender.com">
    <!-- <meta property="og:image" content="one day..."> -->

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Photon Mod Manager - Balatro Mods">
    <meta name="twitter:description" content="Browse, download, and manage Balatro mods with Photon Mod Manager.">
    <!-- <meta name="twitter:image" content="one day..."> -->
  </head>
  <body>
    <div id="main-container">
      <div id="navbar">
        <button class="hamburger" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <ul class="nav">
          <li>
            <a href="/">Home</a>
          </li>
          <li>
            <a href="/submit">Submit</a>
          </li>
          <li>
            <a href="/browse">Browse</a>
          </li>
          <li>
            <a href="/modpack">Modpacks</a>
          </li>
          <li>
            <a href="/trending">Trending</a>
          </li>
          <li>
            <a href="/stats">Stats</a>
          </li>
          <li>
            <a href="/about">About</a>
          </li>
        </ul>
      </div>
    
      <div class="content-wrapper flex alignment">
        <div id="content-container" style="flex-grow: 1;">
          <div class="wrapper">
            <h1>
              Submit Your Mod
            </h1>
            <p style="color: var(--text-light); margin-bottom: 2rem;">
              Share your creation with the Balatro modding community! Simply provide the details to your GitHub repository below and it'll be submitted.
            </p>

            <div style="background: rgba(255, 154, 0, 0.1); border-left: 4px solid #ff9a00; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
              <strong style="color: #ff9a00;">⚠️ Important:</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">
                Your metadata JSON file must have an <code style="background: rgba(0, 0, 0, 0.3); padding: 0.2rem 0.4rem; border-radius: 4px;">allow_redistribution</code> variable set to <code style="background: rgba(0, 0, 0, 0.3); padding: 0.2rem 0.4rem; border-radius: 4px;">true</code>. This is done to prevent unauthorized redistribution of your work.
              </p>
            </div>
          </div>

          <div class="wrapper">
            <form id="gh-form">
              <div class="form-group" style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-white);">
                  <span style="font-size: 1.1rem;">GitHub Repository URL</span>
                </label>
                <small style="display: block; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                  Navigate to your repository on GitHub and copy the URL from your browser's address bar.
                </small>
                <input name="repoUrl" type="url" required placeholder="https://github.com/username/repository" style="width: 100%; max-width: 600px;">
              </div>

              <div class="form-group" style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-white);">
                  <span style="font-size: 1.1rem;">Metadata JSON Path (Optional)</span>
                </label>
                <small style="display: block; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">
                  Leave blank to automatically detect or provide the path to your mod's metadata file within your repository (e.g., data/info.json, manifest.json).
                </small>
                <input name="jsonPath" type="text" placeholder="Leave blank to autodetect or specify a path: data/mod.json" style="width: 100%; max-width: 600px;">
              </div>

              <div class="form-group" style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 1rem; font-weight: 600; color: var(--text-white);">
                  <span style="font-size: 1.1rem;">Select Tags</span>
                </label>
                <small style="display: block; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5;">
                  Choose one or more tags that describe your mod. Click to select/deselect.
                </small>
                
                <fieldset style="border: none; padding: 0; margin: 0;">
                  <div class="tag-options">
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Textures">
                      <span class="label-text">Textures</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="SFX">
                      <span class="label-text">SFX / Music</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Vanilla Plus">
                      <span class="label-text">Vanilla Plus</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Jokers">
                      <span class="label-text">Jokers</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Consumables">
                      <span class="label-text">Consumables</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Cards">
                      <span class="label-text">Cards</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Blinds">
                      <span class="label-text">Blinds</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Modifiers">
                      <span class="label-text">Modifiers</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Mechanics">
                      <span class="label-text">Mechanics</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Quality of Life">
                      <span class="label-text">Quality of Life</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="JokerForge">
                      <span class="label-text">JokerForge</span>
                    </label>
                    <label class="switch">
                      <input type="checkbox" name="tags" value="Misc">
                      <span class="label-text">Miscellaneous</span>
                    </label>
                  </div>
                </fieldset>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-white);">
                  <span style="font-size: 0.9rem;">Images (Optional - up to 10)</span>
                </label>
                
                <div class="file-upload-wrapper" style="position: relative;">
                  <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                  <button type="button" id="upload-trigger" class="click-me" style="width: 100%; padding: 2rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px dashed rgba(102, 126, 234, 0.5); cursor: pointer; transition: all 0.3s;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span id="upload-text" style="font-size: 1rem; font-weight: 600;">Click to add images or drag & drop</span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">PNG, JPG, GIF, WebP (max 5MB each)</span>
                  </button>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                  Upload screenshots of your mod. Click the star icon on any image to set it as the thumbnail (optional).
                </p>
                
              <div id="image-preview-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
            </div>

              <div style="text-align: center; padding: 2rem 0;">
                <button class="click-me" type="submit" style="font-size: 1.1rem; padding: 1.25rem 3rem;">
                  Submit Mod
                </button>
              </div>

              <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-top: 2rem;">
                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary); text-align: center; line-height: 1.6;">
                  ⚠️ By submitting, you confirm that you have permission to redistribute this mod and that it complies with all applicable licenses.
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div id="footer">
        <div class="footer-wrapper">
          <p>
            A website meant to manage mods from Balatro by LocalThunk. We do not claim to own Balatro in any way.
          </p>
        </div>
      </div>
    </div>

    <script type="module" src="js/toast.js"></script>
    <script type="module" src="js/keyboard.js"></script>
    <script type="module" src="js/confetti.js"></script>
    <script type="module" src="js/pageTransitions.js"></script>
    <script type="module" src="js/cookieConsent.js"></script>
    <script type="module" src="js/submit.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const hamburger = document.querySelector('.hamburger');
        const nav = document.querySelector('.nav');

        if (hamburger)
        {
          hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            nav.classList.toggle('active');
          });

          nav.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
              hamburger.classList.remove('active');
              nav.classList.remove('active');
            });
          });
        }
      });
    </script>
    <script>
      (function() {
        const imageUpload = document.getElementById('image-upload');
        const uploadTrigger = document.getElementById('upload-trigger');
        const uploadText = document.getElementById('upload-text');
        const previewContainer = document.getElementById('image-preview-container');
      
        let uploadedImages = [];
        let thumbnailIndex = null;

        uploadTrigger.addEventListener('click', () => imageUpload.click());

        uploadTrigger.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadTrigger.style.borderColor = 'var(--accent-blue)';
          uploadTrigger.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%)';
        });

        uploadTrigger.addEventListener('dragleave', () => {
          uploadTrigger.style.borderColor = 'rgba(102, 126, 234, 0.5)';
          uploadTrigger.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)';
        });

        uploadTrigger.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadTrigger.style.borderColor = 'rgba(102, 126, 234, 0.5)';
          uploadTrigger.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)';
          
          const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
          if (files.length > 0) 
            addImages(files);
        });

        imageUpload.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          addImages(files);
          e.target.value = '';
        });

        function addImages(files) 
        {
          if (uploadedImages.length + files.length > 10) 
          {
            alert(`You can only upload up to 10 images. Currently have ${uploadedImages.length}.`);
            return;
          }

          files.forEach(file => {
            if (file.size > 5 * 1024 * 1024) 
            {
              alert(`File ${file.name} is too large (max 5MB)`);
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              const imageData = {
                file: file,
                dataUrl: e.target.result,
                id: Date.now() + '-' + Math.random()
              };
                  
              uploadedImages.push(imageData);
              renderImages();
                  
              console.log('[ImageUpload] Added image:', file.name, 'Data URL length:', e.target.result.length);
            };
              
            reader.onerror = (e) => {
              console.error('[ImageUpload] FileReader error:', e);
              alert(`Failed to read file ${file.name}`);
            };
              
            reader.readAsDataURL(file);
          });
        }

        function removeImage(id) 
        {
          const index = uploadedImages.findIndex(img => img.id === id);
          if (index === -1) 
            return;

          if (thumbnailIndex === index) 
            thumbnailIndex = null;
          else if (thumbnailIndex !== null && index < thumbnailIndex) 
            thumbnailIndex--;

          uploadedImages.splice(index, 1);
          renderImages();
        }

        function toggleThumbnail(index) 
        {
          thumbnailIndex = (thumbnailIndex === index) ? null : index;
          renderImages();
        }

        function renderImages() 
        {
          previewContainer.innerHTML = '';

          if (uploadedImages.length === 0) 
          {
            uploadText.textContent = 'Click to add images or drag & drop';
            return;
          }

          uploadText.textContent = `Add more images (${uploadedImages.length}/10)`;

          uploadedImages.forEach((imageData, index) => {
            const div = document.createElement('div');
            div.style.cssText = `
              position: relative;
              border-radius: 8px;
              overflow: hidden;
              border: 3px solid ${thumbnailIndex === index ? 'var(--accent-blue)' : 'transparent'};
              transition: all 0.3s;
              animation: fadeIn 0.3s ease;
            `;
            
            const isThumbnail = thumbnailIndex === index;
            
            const img = document.createElement('img');
            img.src = imageData.dataUrl;
            img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; display: block;';
            img.onerror = () => {
              console.error('[ImageUpload] Failed to display image:', imageData.file.name);
              div.style.display = 'none';
            };
            
            div.appendChild(img);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '×';
            removeBtn.style.cssText = `
              position: absolute;
              top: 0.5rem;
              left: 0.5rem;
              background: rgba(255, 59, 48, 0.9);
              border: none;
              color: white;
              width: 28px;
              height: 28px;
              border-radius: 50%;
              cursor: pointer;
              font-size: 1.4rem;
              line-height: 1;
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
              transition: all 0.2s;
            `;

            removeBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              removeImage(imageData.id);
            });
            removeBtn.addEventListener('mouseenter', () => removeBtn.style.transform = 'scale(1.1)');
            removeBtn.addEventListener('mouseleave', () => removeBtn.style.transform = 'scale(1)');
            div.appendChild(removeBtn);

            const thumbBtn = document.createElement('button');
            thumbBtn.type = 'button';
            thumbBtn.textContent = isThumbnail ? '⭐ Thumbnail' : '☆ Set thumbnail';
            thumbBtn.style.cssText = `
              position: absolute;
              top: 0.5rem;
              right: 0.5rem;
              background: ${isThumbnail ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(0, 0, 0, 0.7)'};
              border: none;
              color: white;
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
              cursor: pointer;
              font-size: 0.75rem;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
              transition: all 0.2s;
            `;
            thumbBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              toggleThumbnail(index);
            });
            thumbBtn.addEventListener('mouseenter', () => thumbBtn.style.transform = 'scale(1.05)');
            thumbBtn.addEventListener('mouseleave', () => thumbBtn.style.transform = 'scale(1)');
            div.appendChild(thumbBtn);

            const nameDiv = document.createElement('div');
            nameDiv.textContent = imageData.file.name.length > 20 ? 
              imageData.file.name.substring(0, 20) + '...' : 
              imageData.file.name;
            nameDiv.style.cssText = `
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
              padding: 0.5rem;
              font-size: 0.75rem;
              color: white;
            `;
            div.appendChild(nameDiv);

            div.addEventListener('mouseenter', () => {
              if (thumbnailIndex !== index) 
                div.style.borderColor = 'rgba(102, 126, 234, 0.5)';
            });
            div.addEventListener('mouseleave', () => {
              if (thumbnailIndex !== index) 
                div.style.borderColor = 'transparent';
            });

            previewContainer.appendChild(div);
          });

          console.log('[ImageUpload] Rendered', uploadedImages.length, 'images');
        }

        window.getUploadedImages = () => uploadedImages;
        window.getThumbnailIndex = () => thumbnailIndex;
      })();
    </script>
    <script type="module">
      import { toast } from './js/toast.js';
      import { confetti } from './js/confetti.js';

      const form = document.getElementById('gh-form');
      let isSubmitting = false;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (isSubmitting) 
        {
          toast.warning('Please wait, submission in progress...');
          return;
        }
        
        isSubmitting = true;
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalHTML = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></div>Submitting...';
        
        try 
        {
          const formData = {
            repoUrl: document.querySelector('[name="repoUrl"]').value,
            jsonPath: document.querySelector('[name="jsonPath"]').value || 'manifest.json',
            tags: Array.from(document.querySelectorAll('[name="tags"]:checked')).map(cb => cb.value)
          };
            
          console.log('[Submit] Step 1: Submitting mod metadata:', formData);
            
          const modResponse = await fetch('/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
            
          if (!modResponse.ok) 
          {
            const error = await modResponse.json();
            throw new Error(error.error || 'Failed to submit mod');
          }
            
          const modResult = await modResponse.json();
          const modKey = modResult.key;
            
          console.log('[Submit] Step 1 complete: Mod key =', modKey);
            
          const uploadedImages = window.getUploadedImages ? window.getUploadedImages() : [];
          const thumbnailIndex = window.getThumbnailIndex ? window.getThumbnailIndex() : null;
            
          if (uploadedImages.length > 0) 
          {
            console.log('[Submit] Step 2: Uploading', uploadedImages.length, 'images...');
            console.log('[Submit] Thumbnail index:', thumbnailIndex);
                
            const imageFormData = new FormData();
            imageFormData.append('modKey', modKey);
                
            uploadedImages.forEach((imageData, index) => {
              imageFormData.append('images', imageData.file);
              console.log('[Submit] Added image', index, ':', imageData.file.name, imageData.file.size, 'bytes');
            });
                
            imageFormData.append('thumbnailIndex', thumbnailIndex !== null ? thumbnailIndex : '-1');
                
            console.log('[Submit] Sending image upload request...');
                
            const imageResponse = await fetch('/upload-images', { method: 'POST', body: imageFormData });
                
            if (!imageResponse.ok) 
            {
              const errorText = await imageResponse.text();
              console.error('[Submit] Image upload failed:', errorText);
              toast.warning('Mod submitted but images failed to upload');
            } 
            else 
            {
              const imageResult = await imageResponse.json();
              console.log('[Submit] Step 2 complete: Images uploaded:', imageResult);
              toast.success(`Uploaded ${imageResult.images.length} images!`);
            }
          } 
          else console.log('[Submit] No images to upload');
            
            // Success!
          console.log('[Submit] All done! Redirecting to mod page...');
          confetti.celebrate(3000, 200);
          toast.success('Mod submitted successfully!');
            
          setTimeout(() => window.location.href = `/mod.html?key=${encodeURIComponent(modKey)}`, 2000);
        } 
        catch (error) 
        {
          console.error('[Submit] Error:', error);
          toast.error(error.message || 'Failed to submit mod');
            
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalHTML;
        }
      });
    </script>
  </body>
</html>
